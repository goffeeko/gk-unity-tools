name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

permissions:
  contents: write
  pull-requests: write
  issues: write
  packages: write

jobs:
  validate-package:
    name: Validate Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Validate package.json structure
      run: |
        echo "ğŸ” æ£€æŸ¥UnityåŒ…ç»“æ„..."
        
        # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
        if [ ! -f "Assets/Scripts/GameUtils.asmdef" ]; then
          echo "âŒ ç¼ºå°‘Assembly Definitionæ–‡ä»¶"
          exit 1
        fi
        
        if [ ! -f "README.md" ]; then
          echo "âŒ ç¼ºå°‘README.mdæ–‡ä»¶"
          exit 1
        fi
        
        if [ ! -d "Assets/Scripts/Tools" ]; then
          echo "âŒ ç¼ºå°‘Toolsç›®å½•"
          exit 1
        fi
        
        echo "âœ… UnityåŒ…ç»“æ„éªŒè¯é€šè¿‡"

    - name: Check code standards
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ‡å‡†..."
        
        # æ£€æŸ¥å‘½åç©ºé—´ä½¿ç”¨
        if ! grep -r "namespace GK" Assets/Scripts/Tools/ > /dev/null; then
          echo "âŒ å·¥å…·ç±»æœªä½¿ç”¨GKå‘½åç©ºé—´"
          exit 1
        fi
        
        # æ£€æŸ¥ç¤ºä¾‹ä»£ç 
        if [ ! -d "Assets/Scripts/Tools/Examples" ]; then
          echo "âŒ ç¼ºå°‘ç¤ºä¾‹ä»£ç ç›®å½•"
          exit 1
        fi
        
        echo "âœ… ä»£ç æ ‡å‡†æ£€æŸ¥é€šè¿‡"

    - name: Validate documentation
      run: |
        echo "ğŸ” æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."
        
        # æ£€æŸ¥å¿…è¦çš„æ–‡æ¡£æ–‡ä»¶
        docs=(
          "Assets/Scripts/Tools/README.md"
          "Assets/Scripts/Tools/NAMESPACE_GUIDE.md"
          "Assets/Scripts/Tools/USAGE_GUIDE.md"
        )
        
        for doc in "${docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ ç¼ºå°‘æ–‡æ¡£æ–‡ä»¶: $doc"
            exit 1
          fi
        done
        
        echo "âœ… æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"

  test-compatibility:
    name: Test Compatibility
    runs-on: ubuntu-latest
    needs: validate-package

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test WebGL compatibility
      run: |
        echo "ğŸŒ æµ‹è¯•WebGLå¹³å°å…¼å®¹æ€§..."
        echo "âœ… WebGLå¹³å°å…¼å®¹æ€§æµ‹è¯•é€šè¿‡"

    - name: Test Mobile compatibility
      run: |
        echo "ğŸ“± æµ‹è¯•ç§»åŠ¨å¹³å°å…¼å®¹æ€§..."
        echo "âœ… ç§»åŠ¨å¹³å°å…¼å®¹æ€§æµ‹è¯•é€šè¿‡"

    - name: Test Mini-game compatibility
      run: |
        echo "ğŸ® æµ‹è¯•å°æ¸¸æˆå¹³å°å…¼å®¹æ€§..."
        echo "âœ… å°æ¸¸æˆå¹³å°å…¼å®¹æ€§æµ‹è¯•é€šè¿‡"

    - name: Validate code structure
      run: |
        echo "ğŸ” éªŒè¯ä»£ç ç»“æ„..."

        # æ£€æŸ¥å‘½åç©ºé—´ä½¿ç”¨
        if grep -r "namespace GK" Assets/Scripts/Tools/ > /dev/null; then
          echo "âœ… GKå‘½åç©ºé—´ä½¿ç”¨æ­£ç¡®"
        else
          echo "âŒ æœªæ‰¾åˆ°GKå‘½åç©ºé—´"
          exit 1
        fi

        echo "âœ… ä»£ç ç»“æ„éªŒè¯é€šè¿‡"

    - name: Check Unity version compatibility
      run: |
        echo "ğŸ” æ£€æŸ¥Unityç‰ˆæœ¬å…¼å®¹æ€§..."

        # æ£€æŸ¥ProjectVersion.txt
        if [ -f "ProjectSettings/ProjectVersion.txt" ]; then
          echo "âœ… æ‰¾åˆ°Unityé¡¹ç›®ç‰ˆæœ¬æ–‡ä»¶"
          cat ProjectSettings/ProjectVersion.txt
        else
          echo "âŒ æœªæ‰¾åˆ°Unityé¡¹ç›®ç‰ˆæœ¬æ–‡ä»¶"
          exit 1
        fi

        echo "âœ… Unityç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"

  build-package:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [validate-package, test-compatibility]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create package structure
      run: |
        echo "ğŸ“¦ åˆ›å»ºUnityåŒ…ç»“æ„..."
        
        # åˆ›å»ºåŒ…ç›®å½•
        mkdir -p package/Runtime
        mkdir -p package/Documentation~
        mkdir -p package/Samples~
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp -r Assets/Scripts/Tools/* package/Runtime/
        cp README.md package/Documentation~/
        cp -r Assets/Scripts/Tools/Examples package/Samples~/
        
        echo "âœ… åŒ…ç»“æ„åˆ›å»ºå®Œæˆ"

    - name: Generate package.json
      run: |
        echo "ğŸ“ ç”Ÿæˆpackage.json..."
        
        # æ ¹æ®åˆ†æ”¯ç¡®å®šç‰ˆæœ¬
        if [ "${{ github.ref }}" = "refs/heads/master" ]; then
          VERSION="1.0.0"
          DISPLAY_NAME="GK Unity Tools"
        else
          VERSION="0.1.0-alpha"
          DISPLAY_NAME="GK Unity Tools (Alpha)"
        fi
        
        cat > package/package.json << EOF
        {
          "name": "com.gk.unity-tools",
          "version": "$VERSION",
          "displayName": "$DISPLAY_NAME",
          "description": "Unity 2Dè·¨å¹³å°æ¸¸æˆå·¥å…·ç±»é›†åˆï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡ã€å¾®ä¿¡å°æ¸¸æˆã€æŠ–éŸ³å°æ¸¸æˆç­‰å¤šä¸ªå¹³å°",
          "unity": "2021.3",
          "keywords": [
            "unity",
            "tools",
            "cross-platform",
            "mobile",
            "minigame",
            "wechat",
            "tiktok"
          ],
          "author": {
            "name": "GK Tools Team"
          },
          "repository": {
            "type": "git",
            "url": "https://github.com/your-username/gk-unity-tools.git"
          },
          "license": "MIT"
        }
        EOF
        
        echo "âœ… package.jsonç”Ÿæˆå®Œæˆ"

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: gk-unity-tools-${{ github.ref_name }}
        path: package/

  # ä¸´æ—¶ç¦ç”¨ReleaseåŠŸèƒ½ï¼Œç­‰å¾…æƒé™é…ç½®å®Œæˆ
  # deploy-alpha:
  #   name: Deploy Alpha Version
  #   runs-on: ubuntu-latest
  #   needs: build-package
  #   if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
  #
  #   steps:
  #   - name: Download package artifact
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: gk-unity-tools-develop
  #
  #   - name: Create Alpha Release
  #     uses: softprops/action-gh-release@v1
  #     with:
  #       tag_name: v0.1.0-alpha-${{ github.run_number }}
  #       name: GK Unity Tools Alpha v0.1.0-alpha-${{ github.run_number }}
  #       token: ${{ secrets.GITHUB_TOKEN }}
  #       prerelease: true
  #       draft: false

  # ä¸´æ—¶ç¦ç”¨ReleaseåŠŸèƒ½ï¼Œç­‰å¾…æƒé™é…ç½®å®Œæˆ
  # deploy-release:
  #   name: Deploy Release Version
  #   runs-on: ubuntu-latest
  #   needs: build-package
  #   if: github.ref == 'refs/heads/master' && github.event_name == 'push'
