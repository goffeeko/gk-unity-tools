name: Package Validation

on:
  pull_request:
    branches: [ master, develop ]
    paths:
      - 'Assets/Scripts/**'
      - 'README.md'
      - 'package.json'

jobs:
  validate-structure:
    name: Validate Package Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Unity package structure
      run: |
        echo "ğŸ” éªŒè¯UnityåŒ…ç»“æ„..."
        
        # å¿…éœ€çš„æ–‡ä»¶å’Œç›®å½•
        required_files=(
          "Assets/Scripts/GameUtils.asmdef"
          "Assets/Scripts/GameUtils.cs"
          "README.md"
        )
        
        required_dirs=(
          "Assets/Scripts/Tools"
          "Assets/Scripts/Tools/Platform"
          "Assets/Scripts/Tools/Managers"
          "Assets/Scripts/Tools/Adapters"
          "Assets/Scripts/Tools/Utils"
          "Assets/Scripts/Tools/Examples"
        )
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file"
        done
        
        # æ£€æŸ¥å¿…éœ€ç›®å½•
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€ç›®å½•: $dir"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ç›®å½•: $dir"
        done
        
        echo "ğŸ‰ åŒ…ç»“æ„éªŒè¯é€šè¿‡ï¼"

  validate-namespace:
    name: Validate Namespace Usage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check GK namespace usage
      run: |
        echo "ğŸ” éªŒè¯GKå‘½åç©ºé—´ä½¿ç”¨..."
        
        # æ£€æŸ¥Toolsç›®å½•ä¸‹çš„C#æ–‡ä»¶æ˜¯å¦ä½¿ç”¨GKå‘½åç©ºé—´
        cs_files=$(find Assets/Scripts/Tools -name "*.cs" -not -path "*/Examples/*")
        
        for file in $cs_files; do
          if ! grep -q "namespace GK" "$file"; then
            echo "âŒ æ–‡ä»¶ $file æœªä½¿ç”¨GKå‘½åç©ºé—´"
            exit 1
          fi
          echo "âœ… $file ä½¿ç”¨äº†GKå‘½åç©ºé—´"
        done
        
        echo "ğŸ‰ å‘½åç©ºé—´éªŒè¯é€šè¿‡ï¼"

  validate-documentation:
    name: Validate Unity Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check documentation completeness
      run: |
        echo "ğŸ” éªŒè¯æ–‡æ¡£å®Œæ•´æ€§..."
        
        # å¿…éœ€çš„æ–‡æ¡£æ–‡ä»¶
        required_docs=(
          "README.md"
          "Assets/Scripts/Tools/README.md"
          "Assets/Scripts/Tools/NAMESPACE_GUIDE.md"
          "Assets/Scripts/Tools/USAGE_GUIDE.md"
          "Assets/Scripts/Tools/API_COMPATIBILITY.md"
        )
        
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ ç¼ºå°‘æ–‡æ¡£æ–‡ä»¶: $doc"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "$doc" ]; then
            echo "âŒ æ–‡æ¡£æ–‡ä»¶ä¸ºç©º: $doc"
            exit 1
          fi
          
          echo "âœ… æ–‡æ¡£æ–‡ä»¶å®Œæ•´: $doc"
        done
        
        echo "ğŸ‰ æ–‡æ¡£éªŒè¯é€šè¿‡ï¼"

    - name: Check README structure
      run: |
        echo "ğŸ” éªŒè¯READMEç»“æ„..."
        
        # æ£€æŸ¥READMEå¿…éœ€çš„ç« èŠ‚
        required_sections=(
          "# GK - Unity 2D è·¨å¹³å°æ¸¸æˆå·¥å…·ç±»"
          "## âœ¨ æ ¸å¿ƒç‰¹æ€§"
          "## ğŸš€ å¿«é€Ÿå¼€å§‹"
          "## ğŸ“– æ ¸å¿ƒåŠŸèƒ½ç¤ºä¾‹"
          "## ğŸ¤ è´¡çŒ®"
        )
        
        for section in "${required_sections[@]}"; do
          if ! grep -q "$section" README.md; then
            echo "âŒ READMEç¼ºå°‘å¿…éœ€ç« èŠ‚: $section"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ç« èŠ‚: $section"
        done
        
        echo "ğŸ‰ READMEç»“æ„éªŒè¯é€šè¿‡ï¼"

  validate-examples:
    name: Validate Example Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check example code
      run: |
        echo "ğŸ” éªŒè¯ç¤ºä¾‹ä»£ç ..."
        
        # æ£€æŸ¥ç¤ºä¾‹ç›®å½•
        if [ ! -d "Assets/Scripts/Tools/Examples" ]; then
          echo "âŒ ç¼ºå°‘ç¤ºä¾‹ä»£ç ç›®å½•"
          exit 1
        fi
        
        # å¿…éœ€çš„ç¤ºä¾‹æ–‡ä»¶
        required_examples=(
          "Assets/Scripts/Tools/Examples/QuickStartExample.cs"
          "Assets/Scripts/Tools/Examples/ComprehensiveExample.cs"
          "Assets/Scripts/Tools/Examples/GameUtilsExample.cs"
        )
        
        for example in "${required_examples[@]}"; do
          if [ ! -f "$example" ]; then
            echo "âŒ ç¼ºå°‘ç¤ºä¾‹æ–‡ä»¶: $example"
            exit 1
          fi
          
          # æ£€æŸ¥ç¤ºä¾‹æ–‡ä»¶æ˜¯å¦åŒ…å«åŸºæœ¬çš„usingè¯­å¥
          if ! grep -q "using UnityEngine" "$example"; then
            echo "âŒ ç¤ºä¾‹æ–‡ä»¶ç¼ºå°‘Unityå¼•ç”¨: $example"
            exit 1
          fi
          
          echo "âœ… ç¤ºä¾‹æ–‡ä»¶å®Œæ•´: $example"
        done
        
        echo "ğŸ‰ ç¤ºä¾‹ä»£ç éªŒè¯é€šè¿‡ï¼"

  validate-assembly:
    name: Validate Assembly Definition
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check assembly definition
      run: |
        echo "ğŸ” éªŒè¯Assembly Definition..."
        
        asmdef_file="Assets/Scripts/GameUtils.asmdef"
        
        if [ ! -f "$asmdef_file" ]; then
          echo "âŒ ç¼ºå°‘Assembly Definitionæ–‡ä»¶"
          exit 1
        fi
        
        # æ£€æŸ¥asmdefæ–‡ä»¶å†…å®¹
        if ! grep -q '"name"' "$asmdef_file"; then
          echo "âŒ Assembly Definitionç¼ºå°‘nameå­—æ®µ"
          exit 1
        fi
        
        if ! grep -q '"rootNamespace"' "$asmdef_file"; then
          echo "âŒ Assembly Definitionç¼ºå°‘rootNamespaceå­—æ®µ"
          exit 1
        fi
        
        echo "âœ… Assembly DefinitionéªŒè¯é€šè¿‡"
        
        echo "ğŸ‰ æ‰€æœ‰éªŒè¯å®Œæˆï¼"
